# Tacticus Architecture Refactor
# Orchestrates the migration from SQLite/Rust-LLM to PostGREST/JS-Agent
#
# Usage: prose run tacticus-refactor.prose
#
# Phases:
#   0. Foundation - PostgreSQL + PostGREST setup
#   1. Data Migration - Move from JSON files to database
#   2. JS AI Agent - Replace Rust LLM agent with Vercel AI SDK
#   3. Integration - Wire everything together, test, polish

# ============================================================================
# CONFIGURATION
# ============================================================================

const PROJECT_ROOT = "/Users/haydenw/Projects/Tacticus"
const OBSIDIAN_VAULT = "/Users/haydenw/ObsidianVault"
const CLAUDE_MD = "/Users/haydenw/Projects/Tacticus/CLAUDE.md"

# ============================================================================
# AGENTS
# ============================================================================

# Captain - orchestrates work, reviews progress, never implements directly
agent captain:
  model: sonnet
  persist: true
  prompt: """
    You are the project coordinator for the Tacticus refactor.

    Your responsibilities:
    - Review completed work for quality and correctness
    - Identify blockers and determine next steps
    - Update Obsidian vault with progress
    - Create handoff notes between phases
    - NEVER write implementation code yourself

    Project context:
    - Tacticus is a Tauri 2.0 desktop chess training app
    - Migrating database from JSON files to embedded PostgreSQL + PostGREST
    - Migrating AI agent from Rust to JavaScript (Vercel AI SDK)
    - Keeping Rust for chess-core and chess-engine
    - Windows XP themed UI (no emojis, use ASCII indicators)

    Reference CLAUDE.md for conventions: /Users/haydenw/Projects/Tacticus/CLAUDE.md
  """

# Implementer - does the actual coding work
agent implementer:
  model: opus
  prompt: """
    You are an expert full-stack developer implementing the Tacticus refactor.

    Tech stack:
    - Tauri 2.0 (Rust backend + React frontend)
    - React 19 + TypeScript + Zustand
    - PostgreSQL + PostGREST (embedded/local)
    - Vercel AI SDK for LLM agent
    - Rust for chess-core and chess-engine crates

    Conventions (from CLAUDE.md):
    - TypeScript: Functional components with hooks, Zustand for state
    - Rust: rustfmt + clippy, doc comments on public APIs
    - UI: No emojis - use ASCII indicators like [G], [!], [P]
    - CSS: Use variables from xp-theme.css
    - Git: Conventional commits (feat:, fix:, docs:, etc.)

    Best practices:
    - Follow official documentation for all libraries
    - Write clean, well-documented code
    - Handle errors gracefully
    - Add appropriate tests
  """

# Researcher - investigates approaches, reads docs
agent researcher:
  model: sonnet
  prompt: """
    You research technical solutions and best practices.
    Focus on:
    - Official documentation
    - Production-ready patterns
    - Tauri 2.0 specifics for desktop apps
    - Local-first architecture patterns
  """

# Documenter - updates Obsidian and creates handoffs
agent documenter:
  model: sonnet
  prompt: """
    You maintain project documentation in Obsidian vault.

    Vault location: /Users/haydenw/ObsidianVault
    Project folder: Projects/Tacticus/

    Your tasks:
    - Update progress in existing notes
    - Create handoff documents between phases
    - Document decisions and rationale
    - Keep architecture diagrams current

    Use Obsidian markdown conventions:
    - [[Links]] for internal references
    - Frontmatter for metadata
    - Tags for categorization
  """

# Verifier - runs tests, checks builds
agent verifier:
  model: sonnet
  prompt: """
    You verify that implementations work correctly.

    Verification steps:
    1. Run cargo build --workspace
    2. Run cargo test --workspace
    3. Run npm run build (in tacticus-ui)
    4. Run npm test (in tacticus-ui)
    5. Run npx playwright test for E2E

    Report any failures with full error context.
  """

# ============================================================================
# REUSABLE BLOCKS
# ============================================================================

# Standard task execution pattern: implement -> verify -> document
block execute-task(task_name, task_description, files_to_modify):
  # Update Obsidian with task start
  session: documenter
    prompt: """
      Update the Tacticus Refactor Plan note to mark "{task_name}" as in-progress.
      Add a timestamp and brief description: {task_description}
    """

  # Implement the task
  let implementation = session: implementer
    prompt: """
      Task: {task_name}

      Description: {task_description}

      Files to modify: {files_to_modify}

      Instructions:
      1. Read the relevant files first
      2. Implement the changes following best practices
      3. Reference CLAUDE.md for conventions
      4. Write clean, documented code
      5. Handle errors appropriately
    """

  # Verify the implementation
  let verification = session: verifier
    prompt: "Verify the implementation of: {task_name}"
    context: implementation

  # Captain reviews
  let review = resume: captain
    prompt: "Review the completed task: {task_name}"
    context: { implementation, verification }

  # Update documentation
  session: documenter
    prompt: """
      Update Obsidian for completed task: {task_name}

      Implementation summary: {implementation}
      Verification result: {verification}
      Review notes: {review}

      Mark as completed if verification passed, otherwise note blockers.
    """

# Create handoff document between phases
block create-handoff(from_phase, to_phase, completed_work, next_steps):
  session: documenter
    prompt: """
      Create a handoff document in Obsidian vault at:
      Projects/Tacticus/Handoff - {from_phase} to {to_phase}.md

      Include:
      - Summary of completed work: {completed_work}
      - Key files modified
      - Decisions made and rationale
      - Next steps for {to_phase}: {next_steps}
      - Any blockers or concerns
      - Links to relevant notes
    """

# ============================================================================
# PHASE 0: FOUNDATION
# ============================================================================

block phase-0-foundation():
  session: captain
    prompt: """
      Starting Phase 0: Foundation Setup

      Goals:
      - Set up embedded PostgreSQL for Tauri desktop app
      - Configure PostGREST as local REST API
      - Create database schema with migrations
      - Establish Tauri lifecycle hooks for DB startup/shutdown

      This is a desktop app - everything runs locally, no cloud.
    """

  # Task 0.1: Research embedded PostgreSQL options
  let research = session: researcher
    prompt: """
      Research options for embedding PostgreSQL in a Tauri desktop app:

      Options to evaluate:
      1. postgresql-embedded crate
      2. Bundling PostgreSQL binaries with Tauri
      3. Using libpq with statically linked libraries
      4. Alternative: SQLite with better tooling (sqlx, sea-orm)

      Consider:
      - Cross-platform support (macOS, Windows, Linux)
      - Bundle size implications
      - Startup/shutdown lifecycle
      - Data directory management

      Recommend the best approach for a local-first desktop app.
    """

  resume: captain
    prompt: "Review PostgreSQL research and decide on approach"
    context: research

  # Task 0.2: Set up database infrastructure
  do execute-task(
    "Setup PostgreSQL Infrastructure",
    "Configure embedded PostgreSQL with Tauri lifecycle management",
    "tacticus-ui/src-tauri/src/database/, tacticus-ui/src-tauri/Cargo.toml"
  )

  # Task 0.3: Create database schema
  do execute-task(
    "Create Database Schema",
    "Design and implement schema for profiles, games, conversations, messages, exercise_results with proper migrations",
    "migrations/*.sql, tacticus-ui/src-tauri/src/database/schema.rs"
  )

  # Task 0.4: Set up PostGREST sidecar
  do execute-task(
    "Configure PostGREST Sidecar",
    "Set up PostGREST as a sidecar process managed by Tauri, with proper startup/shutdown",
    "tacticus-ui/src-tauri/src/database/postgrest.rs, tacticus-ui/src-tauri/tauri.conf.json"
  )

  # Create handoff to Phase 1
  do create-handoff(
    "Phase 0 Foundation",
    "Phase 1 Data Migration",
    "PostgreSQL + PostGREST infrastructure ready",
    "Migrate user data, implement PostGREST client, update Zustand stores"
  )

# ============================================================================
# PHASE 1: DATA MIGRATION
# ============================================================================

block phase-1-data-migration():
  session: captain
    prompt: """
      Starting Phase 1: Data Migration

      Goals:
      - Create PostGREST client in frontend
      - Migrate user profile storage from JSON files
      - Implement game persistence
      - Track exercise results
      - Add Zustand persist middleware
    """

  # Task 1.1: Create PostGREST client
  do execute-task(
    "Create PostGREST Client",
    "Implement TypeScript client for PostGREST API with proper typing and error handling",
    "tacticus-ui/src/lib/db.ts, tacticus-ui/src/lib/db/types.ts"
  )

  # Task 1.2: Migrate user store
  do execute-task(
    "Migrate User Store",
    "Update userStore to persist via PostGREST instead of JSON files, add offline caching",
    "tacticus-ui/src/stores/userStore.ts, tacticus-ui/src-tauri/src/commands/user.rs"
  )

  # Task 1.3: Implement game persistence
  do execute-task(
    "Implement Game Persistence",
    "Add game saving/loading via PostGREST, include move history and analysis",
    "tacticus-ui/src/stores/gameStore.ts, tacticus-ui/src/lib/db/games.ts"
  )

  # Task 1.4: Track exercise results
  do execute-task(
    "Track Exercise Results",
    "Persist exercise attempts and results to database for progress tracking",
    "tacticus-ui/src/stores/trainingStore.ts, tacticus-ui/src/lib/db/exercises.ts"
  )

  # Task 1.5: Add Zustand persistence
  do execute-task(
    "Add Zustand Persistence",
    "Configure Zustand persist middleware with IndexedDB for offline support",
    "tacticus-ui/src/stores/index.ts, tacticus-ui/package.json"
  )

  # Verification checkpoint
  let migration_check = session: verifier
    prompt: """
      Verify data migration phase:
      1. User profile persists across app restarts
      2. Games are saved to database
      3. Exercise results are tracked
      4. Offline mode works (data cached in IndexedDB)
    """

  resume: captain
    prompt: "Review data migration results"
    context: migration_check

  do create-handoff(
    "Phase 1 Data Migration",
    "Phase 2 JS AI Agent",
    "Data layer complete with PostGREST and Zustand persistence",
    "Implement Vercel AI SDK agent with tool calling"
  )

# ============================================================================
# PHASE 2: JS AI AGENT
# ============================================================================

block phase-2-js-agent():
  session: captain
    prompt: """
      Starting Phase 2: JavaScript AI Agent

      Goals:
      - Set up Vercel AI SDK
      - Port 7 tool definitions from Rust to TypeScript
      - Implement tool execution with PostGREST queries
      - Add streaming chat support
      - Persist conversations
      - Rewrite GurgrehChat component
    """

  # Task 2.1: Set up Vercel AI SDK
  do execute-task(
    "Setup Vercel AI SDK",
    "Install and configure Vercel AI SDK with OpenRouter provider",
    "tacticus-ui/package.json, tacticus-ui/src/lib/ai/config.ts"
  )

  # Task 2.2: Define tools in TypeScript
  do execute-task(
    "Define AI Tools",
    "Port all 7 tools from Rust to TypeScript with proper Zod schemas: getRecentGames, getPlayerStats, getWeaknessHistory, searchGamesByOpening, getGamesWithMistakes, getTrainingProgress, getImprovementTrend",
    "tacticus-ui/src/lib/ai/tools.ts, tacticus-ui/src/lib/ai/tools/*.ts"
  )

  # Task 2.3: Implement tool execution
  do execute-task(
    "Implement Tool Execution",
    "Wire each tool to PostGREST queries, handle errors gracefully",
    "tacticus-ui/src/lib/ai/tools.ts, tacticus-ui/src/lib/ai/execute.ts"
  )

  # Task 2.4: Create AI agent
  do execute-task(
    "Create AI Agent",
    "Implement the Gurgeh coach agent with system prompts, tool calling loop, and streaming",
    "tacticus-ui/src/lib/ai/agent.ts, tacticus-ui/src/lib/ai/prompts.ts"
  )

  # Task 2.5: Persist conversations
  do execute-task(
    "Persist Conversations",
    "Save chat sessions to database, allow resuming previous conversations",
    "tacticus-ui/src/lib/ai/conversations.ts, tacticus-ui/src/lib/db/conversations.ts"
  )

  # Task 2.6: Rewrite chat component
  do execute-task(
    "Rewrite Chat Component",
    "Update GurgrehChat.tsx for streaming, tool status display, conversation history",
    "tacticus-ui/src/components/gurgeh/GurgrehChat.tsx, tacticus-ui/src/components/gurgeh/GurgrehChat.css"
  )

  # Task 2.7: Remove Rust LLM code
  do execute-task(
    "Remove Rust LLM Code",
    "Remove chess-llm-agent crate from workspace, simplify Tauri coach commands",
    "Cargo.toml, tacticus-ui/src-tauri/Cargo.toml, tacticus-ui/src-tauri/src/commands/coach.rs"
  )

  # Verification
  let agent_check = session: verifier
    prompt: """
      Verify AI agent implementation:
      1. Chat with streaming responses works
      2. All 7 tools execute and return real data
      3. Conversations persist and can be resumed
      4. Tool calls are visible in UI
      5. Error states are handled gracefully
    """

  resume: captain
    prompt: "Review AI agent implementation"
    context: agent_check

  do create-handoff(
    "Phase 2 JS AI Agent",
    "Phase 3 Integration",
    "Vercel AI SDK agent with tool calling complete",
    "Wire everything together, add error handling, polish UI"
  )

# ============================================================================
# PHASE 3: INTEGRATION
# ============================================================================

block phase-3-integration():
  session: captain
    prompt: """
      Starting Phase 3: Integration and Polish

      Goals:
      - Wire all components together
      - Add error boundaries and display
      - Implement secure API key storage
      - Add logging infrastructure
      - Write integration tests
      - Update documentation
    """

  # Task 3.1: Error handling
  do execute-task(
    "Add Error Boundaries",
    "Create error boundary component, add error display to UI, implement retry logic",
    "tacticus-ui/src/components/ErrorBoundary.tsx, tacticus-ui/src/components/xp/ErrorDialog.tsx"
  )

  # Task 3.2: Secure API key storage
  do execute-task(
    "Secure API Key Storage",
    "Encrypt API key at rest using Tauri keyring/secure storage",
    "tacticus-ui/src-tauri/src/commands/user.rs, tacticus-ui/src/stores/userStore.ts"
  )

  # Task 3.3: Logging infrastructure
  do execute-task(
    "Add Logging Infrastructure",
    "Set up tracing in Rust, console logging in JS, log rotation for desktop app",
    "tacticus-ui/src-tauri/src/main.rs, tacticus-ui/src/lib/logger.ts"
  )

  # Task 3.4: Integration tests
  do execute-task(
    "Write Integration Tests",
    "Add Playwright tests for coach chat flow, data persistence, error handling",
    "tacticus-ui/tests/e2e/coach.spec.ts, tacticus-ui/tests/e2e/persistence.spec.ts"
  )

  # Task 3.5: Update CLAUDE.md
  do execute-task(
    "Update Project Documentation",
    "Update CLAUDE.md with new architecture, update README, ensure build instructions work",
    "CLAUDE.md, README.md, ARCHITECTURE.md"
  )

  # Final verification
  let final_check = session: verifier
    prompt: """
      Final verification of complete refactor:
      1. cargo build --workspace succeeds
      2. cargo test --workspace passes
      3. npm run build succeeds
      4. npm test passes
      5. npx playwright test passes
      6. App launches and basic flow works
      7. Data persists across restarts
      8. Coach uses real data in responses
    """

  resume: captain
    prompt: "Final review of complete refactor"
    context: final_check

# ============================================================================
# MAIN EXECUTION
# ============================================================================

# Initialize captain
session: captain
  prompt: """
    Beginning Tacticus Architecture Refactor

    Overview:
    - Phase 0: Foundation (PostgreSQL + PostGREST setup)
    - Phase 1: Data Migration (JSON -> PostGREST)
    - Phase 2: JS AI Agent (Rust -> Vercel AI SDK)
    - Phase 3: Integration (polish, testing, docs)

    Creating initial Obsidian documentation...
  """

# Create initial documentation
session: documenter
  prompt: """
    Create/update the following Obsidian notes:

    1. Projects/Tacticus/Refactor Progress.md
       - Track overall progress
       - List all tasks with status checkboxes
       - Link to handoff documents

    2. Update Projects/Tacticus/Tacticus Refactor Plan.md
       - Mark as "In Progress"
       - Add start timestamp
  """

# Execute all phases
do phase-0-foundation()
do phase-1-data-migration()
do phase-2-js-agent()
do phase-3-integration()

# Final summary
output summary = resume: captain
  prompt: """
    Create final summary of the Tacticus refactor:
    - What was accomplished
    - Key decisions made
    - Any remaining issues or tech debt
    - Recommendations for next steps
  """

session: documenter
  prompt: """
    Create final documentation:

    1. Update Projects/Tacticus/Refactor Progress.md - mark complete
    2. Create Projects/Tacticus/Refactor Summary.md with final summary
    3. Update Projects/Tacticus/Index.md with current status
  """
  context: summary
